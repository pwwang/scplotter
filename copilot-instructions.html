<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>scplotter - AI Coding Agent Instructions • scplotter</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" sizes="any" href="favicon.ico"><link rel="manifest" href="site.webmanifest"><script src="lightswitch.js"></script><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="scplotter - AI Coding Agent Instructions"><meta property="og:image" content="https://pwwang.github.io/scplotter/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">scplotter</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/Visualizing_data_with_LLMs.html">Visualizing data with LLMs</a></li>
    <li><a class="dropdown-item" href="articles/Working_with_anndata_h5ad_files.html">Working with anndata (.h5ad) files</a></li>
    <li><a class="dropdown-item" href="articles/Knowing_your_spatial_data_and_visualization.html">Knowing your spatial data and visualization</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-spatial-examples" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Spatial Examples</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-spatial-examples"><li><a class="dropdown-item" href="articles/Seurat_10x_Visium.html">Visualizing 10x Visium data prepared with Seurat</a></li>
    <li><a class="dropdown-item" href="articles/Seurat_10x_VisiumHD.html">Visualizing 10x VisiumHD data prepared with Seurat</a></li>
    <li><a class="dropdown-item" href="articles/Seurat_SlideSeq.html">Visualizing SlideSeq data prepared with Seurat</a></li>
    <li><a class="dropdown-item" href="articles/Seurat_Xenium.html">Visualizing Xenium data prepared with Seurat</a></li>
    <li><a class="dropdown-item" href="articles/Seurat_Nanostring_CosMx.html">Visualizing Nanostring CosMx data prepared with Seurat</a></li>
    <li><a class="dropdown-item" href="articles/Seurat_Akoya_CODEX.html">Visualizing Akoya_CODEX data prepared with Seurat</a></li>
    <li><a class="dropdown-item" href="articles/Giotto_Visium.html">Visualizing Visium data prepared with Giotto</a></li>
    <li><a class="dropdown-item" href="articles/Giotto_VisiumHD.html">Visualizing VisiumHD data prepared with Giotto</a></li>
    <li><a class="dropdown-item" href="articles/Giotto_Xenium.html">Visualizing Xenium data prepared with Giotto</a></li>
    <li><a class="dropdown-item" href="articles/Giotto_SlideSeq.html">Visualizing SlideSeq data prepared with Giotto</a></li>
    <li><a class="dropdown-item" href="articles/Giotto_Spatial_CITE-Seq.html">Visualizing Spatial CITE-Seq data prepared with Giotto</a></li>
    <li><a class="dropdown-item" href="articles/Giotto_Nanostring_CosMx.html">Visualizing Nanostirng CosMx data prepared with Giotto</a></li>
    <li><a class="dropdown-item" href="articles/Giotto_CODEX.html">Visualizing CODEX data prepared with Giotto</a></li>
    <li><a class="dropdown-item" href="articles/Giotto_vizgen.html">Visualizing vizgen data prepared with Giotto</a></li>
    <li><a class="dropdown-item" href="articles/Giotto_seqFISH.html">Visualizing seqFISH data prepared with Giotto</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pwwang/scplotter/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="logo.png" class="logo" alt=""><h1>scplotter - AI Coding Agent Instructions</h1>
      <small class="dont-index">Source: <a href="https://github.com/pwwang/scplotter/blob/master/.github/copilot-instructions.md" class="external-link"><code>.github/copilot-instructions.md</code></a></small>
    </div>

<div id="scplotter---ai-coding-agent-instructions" class="section level1">

<div class="section level2">
<h2 id="project-overview">Project Overview<a class="anchor" aria-label="anchor" href="#project-overview"></a></h2>
<p><code>scplotter</code> is an R package for publication-quality visualizations of single-cell sequencing data. It’s built as a <strong>wrapper layer</strong> around <a href="https://github.com/pwwang/plotthis" class="external-link"><code>plotthis</code></a>, extracting data from Seurat/Giotto objects and .h5ad files to pass to plotthis functions.</p>
<p><strong>Key Architecture Principle</strong>: This package does NOT implement core plotting logic. It transforms single-cell data structures into formats compatible with <code>plotthis</code>, which handles the actual visualization.</p>
</div>
<div class="section level2">
<h2 id="core-components">Core Components<a class="anchor" aria-label="anchor" href="#core-components"></a></h2>
<div class="section level3">
<h3 id="plot-function-categories">Plot Function Categories<a class="anchor" aria-label="anchor" href="#plot-function-categories"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>scRNA-seq</strong>: <code>CellDimPlot</code>, <code>CellStatPlot</code>, <code>FeatureStatPlot</code>, <code>EnrichmentPlot</code>, <code>MarkersPlot</code>, <code>CCCPlot</code> (cell-cell communication)</li>
<li>
<strong>scTCR/BCR-seq</strong>: <code>Clonal*Plot</code> family (15+ functions for TCR/BCR repertoire analysis via <code>scRepertoire</code>)</li>
<li>
<strong>Spatial</strong>: <code>SpatDimPlot</code>, <code>SpatFeaturePlot</code> with multi-platform support (Visium, VisiumHD, Xenium, CosMx, CODEX, etc.)</li>
<li>
<strong>LLM Integration</strong>: <code>SCPlotterChat</code> R6 class using <code>tidyprompt</code> for natural language plot generation</li>
</ol></div>
<div class="section level3">
<h3 id="data-flow-pattern">Data Flow Pattern<a class="anchor" aria-label="anchor" href="#data-flow-pattern"></a></h3>
<p>All plot functions follow this structure:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>Plot<span class="sc">*</span>() <span class="ot">-&gt;</span> <span class="fu">UseMethod</span>() <span class="ot">-&gt;</span> Plot<span class="sc">*</span>.Seurat <span class="sc">/</span> Plot<span class="sc">*</span>.giotto <span class="sc">/</span> Plot<span class="sc">*</span>.H5File <span class="ot">-&gt;</span> plotthis<span class="sc">::</span><span class="fu">PlotFunction</span>()</span></code></pre></div>
<p>Functions extract embeddings, metadata, graphs from objects, then delegate to <code>plotthis</code>. See <code>R/celldimplot.R</code> (lines 1-100) for the canonical pattern.</p>
</div>
</div>
<div class="section level2">
<h2 id="critical-development-patterns">Critical Development Patterns<a class="anchor" aria-label="anchor" href="#critical-development-patterns"></a></h2>
<div class="section level3">
<h3 id="id_1-object-support-via-s3-methods">1. Object Support via S3 Methods<a class="anchor" aria-label="anchor" href="#id_1-object-support-via-s3-methods"></a></h3>
<p>Functions must support multiple object types through S3 dispatch: - <code>Seurat</code> objects (via <code>SeuratObject</code> package) - <code>giotto</code> objects (via <code>GiottoClass</code>) - <code>.h5ad</code> files (paths or <code><a href="http://hhoeflin.github.io/hdf5r/reference/H5File-class.html" class="external-link">hdf5r::H5File</a></code> objects)</p>
<p>Example: <code>SpatPlot.Seurat</code>, <code>SpatPlot.giotto</code>, <code>SpatPlot.H5File</code> in <code>R/spatialplot.R</code></p>
</div>
<div class="section level3">
<h3 id="id_2-import-strategy">2. Import Strategy<a class="anchor" aria-label="anchor" href="#id_2-import-strategy"></a></h3>
<ul><li>Use <code>@importFrom</code> for specific functions (never <code>@import</code> for entire packages except R6)</li>
<li>Import from <code>plotthis</code> heavily: <code>@importFrom plotthis DimPlot ChordPlot Heatmap ...</code>
</li>
<li>Import helper functions via <code><a href="https://rdrr.io/r/utils/getFromNamespace.html" class="external-link">getFromNamespace()</a></code>: <code>check_columns &lt;- getFromNamespace("check_columns", "plotthis")</code> (see <code>R/utils.R</code>)</li>
<li>Tidyverse imports: <code>@importFrom dplyr filter mutate group_by</code>, <code>@importFrom tidyr pivot_wider</code>
</li>
</ul></div>
<div class="section level3">
<h3 id="id_3-clone-selector-dsl-screpertoire">3. Clone Selector DSL (scRepertoire)<a class="anchor" aria-label="anchor" href="#id_3-clone-selector-dsl-screpertoire"></a></h3>
<p>Unique feature: expression-based clone selection in <code>Clonal*Plot</code> functions - Users write: <code>clones = "top(3)"</code> or <code>clones = "shared() &amp; gt(5)"</code> - Implementation: <code><a href="https://rlang.r-lib.org/reference/parse_expr.html" class="external-link">rlang::parse_expr()</a></code> evaluates selectors as functions - Selector functions: <code><a href="reference/clone_selectors.html">top()</a></code>, <code><a href="reference/clone_selectors.html">shared()</a></code>, <code><a href="reference/clone_selectors.html">uniq()</a></code>, <code><a href="reference/clone_selectors.html">gt()</a></code>, <code><a href="reference/clone_selectors.html">ge()</a></code>, <code><a href="reference/clone_selectors.html">lt()</a></code>, <code><a href="reference/clone_selectors.html">le()</a></code>, <code><a href="reference/clone_selectors.html">and()</a></code>, <code><a href="reference/clone_selectors.html">or()</a></code>, <code><a href="reference/clone_selectors.html">sel()</a></code> - See <code>R/clonalutils.R</code> (lines 360+) and test files in <code>tests/testthat/test-clone_selectors_*.R</code></p>
</div>
<div class="section level3">
<h3 id="id_4-h5ad-file-support">4. H5AD File Support<a class="anchor" aria-label="anchor" href="#id_4-h5ad-file-support"></a></h3>
<ul><li>Read .h5ad files using <code>hdf5r</code> package</li>
<li>Helpers: <code><a href="reference/h5group_to_dataframe.html">h5group_to_dataframe()</a></code>, <code><a href="reference/h5group_to_matrix.html">h5group_to_matrix()</a></code> in <code>R/utils.R</code>
</li>
<li>Handle sparse matrices (CSR format) and categorical data from AnnData</li>
<li>See vignette: <code>vignettes/Working_with_anndata_h5ad_files.Rmd</code>
</li>
</ul></div>
<div class="section level3">
<h3 id="id_5-spatial-data-complexity">5. Spatial Data Complexity<a class="anchor" aria-label="anchor" href="#id_5-spatial-data-complexity"></a></h3>
<p>Spatial functions (<code>R/spatialplot.R</code>) handle multiple coordinate systems: - <strong>Visium</strong>: <code>imagerow</code>/<code>imagecol</code> coordinates, scale_factor=1 - <strong>VisiumHD</strong>: Flexible binning, requires <code>scale_factor</code> parameter - <strong>FOV-based</strong> (Xenium, CosMx): <code>x</code>/<code>y</code> coordinates, optional molecule points (<code>nmols</code>) - <strong>Giotto</strong>: Uses <code>spat_unit</code>, <code>feat_type</code>, <code>spat_loc_name</code> parameters</p>
<p>Check object type first: <code>class(object@images[[first_image]])</code> → dispatch to appropriate handler</p>
</div>
</div>
<div class="section level2">
<h2 id="build--test-workflow">Build &amp; Test Workflow<a class="anchor" aria-label="anchor" href="#build--test-workflow"></a></h2>
<div class="section level3">
<h3 id="development-commands-makefile">Development Commands (Makefile)<a class="anchor" aria-label="anchor" href="#development-commands-makefile"></a></h3>
<pre class="fish"><code>make readme        # Build README from README.Rmd
make docs          # Generate documentation + pkgdown site
make install       # Build and install package locally
make test          # Run testthat tests
make notebooks     # Convert notebooks to HTML (use EXECUTE=true to run)</code></pre>
</div>
<div class="section level3">
<h3 id="testing">Testing<a class="anchor" aria-label="anchor" href="#testing"></a></h3>
<ul><li>Framework: <code>testthat</code> (see <code>tests/testthat/test-*.R</code>)</li>
<li>Focus on clone selector logic, not plot outputs</li>
<li>Run via <code><a href="https://devtools.r-lib.org/reference/test.html" class="external-link">devtools::test()</a></code> or <code>make test</code>
</li>
</ul></div>
<div class="section level3">
<h3 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a></h3>
<ul><li>Roxygen2 for function docs (roxygen2 7.3.3)</li>
<li>pkgdown site config: <code>_pkgdown.yml</code> (Bootstrap 5, litera theme)</li>
<li>Spatial examples in <code>vignettes/articles/</code> (16 platform-specific tutorials)</li>
</ul></div>
<div class="section level3">
<h3 id="cicd-githubworkflowsmainyml">CI/CD (.github/workflows/main.yml)<a class="anchor" aria-label="anchor" href="#cicd-githubworkflowsmainyml"></a></h3>
<ul><li>Runs on Ubuntu (R 4.4.1)</li>
<li>Installs system dep: <code>libglpk40</code> for igraph</li>
<li>Builds pkgdown site, deploys to gh-pages</li>
<li>Requires <code>OPENAI_API_KEY</code> secret for LLM vignette</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="package-dependencies">Package Dependencies<a class="anchor" aria-label="anchor" href="#package-dependencies"></a></h2>
<p><strong>Core</strong>: <code>plotthis</code> (main plotting engine), <code>scRepertoire</code> (&gt;= 2.0.8, &lt; 2.3.2), <code>Seurat</code> (&gt;= 5.0.0), <code>SeuratObject</code></p>
<p><strong>Spatial</strong>: <code>GiottoClass</code>, <code>GiottoData</code>, <code>hdf5r</code>, <code>terra</code></p>
<p><strong>TCR/BCR</strong>: <code>scRepertoire</code>, <code>iNEXT</code> (rarefaction), <code>metap</code> (&gt;= 1.11, p-value combination)</p>
<p><strong>LLM</strong>: <code>tidyprompt</code> (from GitHub: KennispuntTwente/tidyprompt), <code>callr</code></p>
<p><strong>Remotes</strong>: <code>plotthis</code>, <code>GiottoClass</code>, <code>GiottoData</code>, <code>tidyprompt</code> installed from GitHub via <code>Remotes:</code> field</p>
</div>
<div class="section level2">
<h2 id="common-pitfalls">Common Pitfalls<a class="anchor" aria-label="anchor" href="#common-pitfalls"></a></h2>
<ol style="list-style-type: decimal"><li>
<strong>Don’t implement plots</strong>: Call <code>plotthis::*Plot()</code>, don’t reinvent visualization logic</li>
<li>
<strong>Version constraints</strong>: <code>scRepertoire</code> locked to 2.0.8-2.3.1 (API changes), <code>ggVennDiagram &gt;= 1.5.0</code>
</li>
<li>
<strong>Lazy data</strong>: <code>LazyData: true</code> with <code>xz</code> compression for included datasets (<code>data/*.rda</code>)</li>
<li>
<strong>Clone selector scope</strong>: Selectors evaluate in caller environment - use <code><a href="https://rlang.r-lib.org/reference/stack.html" class="external-link">rlang::caller_env()</a></code> carefully</li>
<li>
<strong>Spatial coords</strong>: Always check platform-specific coordinate naming (x/y vs imagerow/imagecol)</li>
</ol></div>
<div class="section level2">
<h2 id="when-adding-new-plot-functions">When Adding New Plot Functions<a class="anchor" aria-label="anchor" href="#when-adding-new-plot-functions"></a></h2>
<ol style="list-style-type: decimal"><li>Create S3 generic + methods for Seurat/giotto/H5File</li>
<li>Extract necessary data (embeddings, metadata, matrices)</li>
<li>Transform to format expected by <code>plotthis::*Plot()</code>
</li>
<li>Add <code>@importFrom</code> statements for all dependencies</li>
<li>Write examples using included datasets: <code>pancreas_sub</code>, <code>ifnb_sub</code>, <code>cellphonedb_res</code>
</li>
<li>Add vignette if introducing new data type or analysis workflow</li>
</ol></div>
<div class="section level2">
<h2 id="llm-chat-integration">LLM Chat Integration<a class="anchor" aria-label="anchor" href="#llm-chat-integration"></a></h2>
<p><code>SCPlotterChat</code> (R6 class in <code>R/chat.R</code>) enables: - Natural language plot requests: <code>chat$ask("Plot cell-cell communication as heatmap")</code> - Auto-detects datasets from <code>.GlobalEnv</code> and package data - Maintains conversation history for context - Tool discovery from package namespace</p>
<p>Uses <code>tidyprompt</code> for provider abstraction (OpenAI, Anthropic, etc.)</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Panwen Wang.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

